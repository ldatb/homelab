- name: Create Calico resources - Tigera Operator
  command: kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.24.5/manifests/tigera-operator.yaml
  
- name: Create custom calico resources file
  template:
    src: calico-custom-resource-yaml.j2
    dest: "~/calico-custom-resource.yaml"

- name: Create Calico resources - Custom resources
  command: kubectl create -f ~/calico-custom-resource.yaml

- name: Delete Calico custom resources file
  file:
    path: ~/calico-custom-resource.yaml
    state: absent

- name: Wait for Calico pods to come up
  shell: kubectl get pods -n calico-system -o json
  register: calico_pods
  until: calico_pods.stdout|from_json|json_query('items[*].status.phase')|unique == ["Running"]
